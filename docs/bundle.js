(()=>{"use strict";function e(e=10){this.nowObject=performance||Date,this.pollTime=e,this.renderAccum=0,this.lastTickStarted=0,this.lastFrameStarted=0,this.lastRenderStarted=0,this.avgTickTime=2,this.frameCB=null,this.intervalCB=null,this.intervalID=-1}function t(e,t=!1){var n=e._data,r=n.nowObject.now(),i=r;t&&(i+=n.avgTickTime);var o,a,c=r+e.maxTickTime;c>r||(c=r+1);for(var s=1e3/e.tickRate;n.lastTickStarted+s<i;){e.onTick(s),n.lastTickStarted+=s;var l=n.nowObject.now();if(n.avgTickTime=(o=n.avgTickTime,(a=l-r)>4*o&&(a=4*o),a<.25*o&&(a=.25*o),.9*o+.1*a),(r=l)>c)return void(n.lastTickStarted=r)}}var n=document.querySelector.bind(document),r=n(".game"),i=new class{constructor(n=null,r=10){this.stickyPointerLock=!1,this.stickyFullscreen=!1,this.tickRate=30,this.maxRenderRate=0,this.maxTickTime=100,this.pointerLock=!1,this.fullscreen=!1,this.onTick=function(e){},this.onRender=function(e,t,n){},this.onInit=function(){},this.onResize=function(){},this.onPointerLockChanged=function(e=!1){},this.onFullscreenChanged=function(e=!1){},this.onPointerLockError=function(e){},this._data=new e(r),function(e){if("loading"===document.readyState){var t=()=>{document.removeEventListener("readystatechange",t),e()};document.addEventListener("readystatechange",t)}else setTimeout(e,0)}((()=>{!function(e){var n=e._data,r=n.nowObject.now();n.lastTickStarted=r,n.lastFrameStarted=r,n.lastRenderStarted=r,n.frameCB=()=>function(e){var n=e._data;requestAnimationFrame(n.frameCB),t(e);var r=n.nowObject.now(),i=r-n.lastFrameStarted;if(n.lastFrameStarted=r,e.maxRenderRate>0){n.renderAccum+=i;var o=1e3/e.maxRenderRate;if(n.renderAccum<o)return;n.renderAccum-=o,n.renderAccum>o&&(n.renderAccum=o)}var a=r-n.lastRenderStarted;n.lastRenderStarted=r;var c=1e3/e.tickRate,s=(r-n.lastTickStarted)/c;s<0&&(s=0),e.onRender(a,s,c),setTimeout(t,0,e,!0)}(e),n.intervalCB=()=>t(e),requestAnimationFrame(n.frameCB),n.pollTime>0&&(n.intervalID=setInterval(n.intervalCB,n.pollTime))}(this),function(e,t){if(t){var n=!1,r=!1,i=e=>{if(!!e!=(n=t===document.pointerLockElement))if(e){var r=t.requestPointerLock();r&&r.catch&&r.catch((e=>{}))}else document.exitPointerLock()},o=e=>{!!e!=(r=t===document.fullscreenElement)&&(e?t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};document.addEventListener("pointerlockchange",(r=>{n=t===document.pointerLockElement,e.onPointerLockChanged(n)})),document.addEventListener("fullscreenchange",(n=>{r=t===document.fullscreenElement,e.onFullscreenChanged(r)})),document.addEventListener("pointerlockerror",(r=>{n=t===document.pointerLockElement,e.onPointerLockError(r)})),Object.defineProperty(e,"pointerLock",{get:()=>n,set:i}),Object.defineProperty(e,"fullscreen",{get:()=>r,set:o}),t.addEventListener("click",(t=>{e.stickyPointerLock&&i(!0),e.stickyFullscreen&&o(!0)}));var a=()=>e.onResize();window.ResizeObserver?new ResizeObserver(a).observe(t):window.addEventListener("resize",a)}}(this,n),this.onInit()}))}}(r,10);window.shell=i;var o=0,a=0;function c(e,t){var r=n(e);r.oninput=e=>{var n=parseInt(e.target.value);t(isNaN(n)?e.target.checked:n)},setTimeout((()=>{var e=parseInt(r.value);t(isNaN(e)?r.checked:e)}),1)}c("#PL",(e=>{i.stickyPointerLock=e})),c("#FS",(e=>{i.stickyFullscreen=e})),c("#TR",(e=>{i.tickRate=e})),c("#MRR",(e=>{i.maxRenderRate=e})),c("#MTT",(e=>{i.maxTickTime=e})),c("#WTT",(e=>{o=e})),c("#WTR",(e=>{a=e})),n(".spike").onclick=()=>C(500);var s=x(),l=1,d=0;i.onTick=e=>{if(v){var t=performance.now();console.log("  tick","dt",t-d,"dur",e),d=t}var r;(h+=600*(r=e)/1e3)>g&&(h-=g),(R+=50*r/1e3)>p&&(R-=p);var i=s();0==--l&&(n("#OTR").textContent=Math.round(i),l=Math.ceil(i/5)),C(o)};var u=x(),m=1;i.onRender=(e,t,r)=>{if(v){var i=t*r;console.log("render","dt",e.toFixed(2),"   part",t.toFixed(2),"   ms in:",i.toFixed(2))}!function(e,t){var n=(h+e*(T*t/1e3))%g,r=R+e*(50*t/1e3);if(0===w)S(1),b(n,30,40,40);else if(1===w){S(L++%10==0?.15:.05);b(n,r,2,30),r>p-30&&b(n,r-p,2,30)}else{var i=n-F;i<-g/2&&(i+=g),F=n,S(.02),f.globalCompositeOperation="copy",f.drawImage(f.canvas,-i,0),f.globalCompositeOperation="source-over",b(g-15,10,1,p-20)}}(t,r);var o=u();0==--m&&(n("#OFR").textContent=Math.round(o),m=Math.ceil(o/5)),C(a)},i.onPointerLockChanged=e=>{console.log(e?"Gained":"Lost","pointerLock")},i.onFullscreenChanged=e=>{console.log(e?"Gained":"Lost","fullScreen")},i.onPointerLockError=e=>{console.log("PointerLock error:",e)};var v=!1;document.addEventListener("keydown",(e=>{"p"===e.key&&(v=!v)}));var k=n(".output"),f=k.getContext("2d"),h=0,T=600,R=0,g=k.width,p=k.height,w=0;k.onclick=()=>{w=(w+1)%3};var L=0,F=0,S=e=>{f.fillStyle=`rgba(255,255,255, ${e})`,f.fillRect(0,0,g,p)},b=(e,t,n,r)=>{f.fillStyle="red",f.fillRect(e,t,n,r)};function x(){var e=0,t=10;return()=>{var n=performance.now(),r=n-e;return e=n,1e3/(t=.9*t+r*(1-.9))}}function C(e=0){for(var t=performance.now();performance.now()<=t+e;);}})();